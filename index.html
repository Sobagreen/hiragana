<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hiragana Practice</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .option-button { transition: transform .2s; }
    .option-button:hover { transform: scale(1.05); }
    .correct { animation: flash-green .5s; }
    .incorrect { animation: flash-red .5s; }
    @keyframes flash-green { from {background:#34d399;} to {background:#fff;} }
    @keyframes flash-red   { from {background:#ef4444;} to {background:#fff;} }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4">Hiragana Practice</h1>
    <div id="user-info" class="text-center mb-4 text-gray-600"></div>
    <div class="text-center mb-4">
      Score: <span id="current-score" class="font-semibold">0</span>
    </div>
    <div id="hiragana" class="text-6xl font-bold text-center mb-6"></div>
    <div id="options" class="space-y-3"></div>
    <div id="feedback" class="text-center mt-4 text-lg"></div>
    <button id="next-button"
            class="mt-6 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 hidden">
      Next
    </button>
  </div>

  <script>
    // — Параметры GitHub API
    const GITHUB_TOKEN = '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';
    const REPO_OWNER    = 'sobagreen';
    const REPO_NAME     = 'hiragana';
    const FILE_PATH     = 'leaderboard.json';
    const BRANCH        = 'main';

    // — Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user || { id:'test', first_name:'Test', last_name:'' };
    document.getElementById('user-info').innerText = `Hello, ${user.first_name}!`;

    // — Игра
    const hiragana = [
      {char:'あ',romaji:'a'},{char:'い',romaji:'i'},{char:'う',romaji:'u'},
      /* …весь набор… */{char:'ん',romaji:'n'}
    ];
    let score = 0, current = null, leaderboard = {};

    // — Получаем файл (или null, если нет)
    async function getFileData() {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      const res = await fetch(url, {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept':        'application/vnd.github.v3+json'
        }
      });
      if (res.status === 404) return null;
      if (!res.ok) {
        console.error('getFileData:', res.status, await res.text());
        return null;
      }
      return res.json();
    }

    // — Загрузка лидеров
    async function fetchLeaderboard() {
      const data = await getFileData();
      if (data && data.content) {
        leaderboard = JSON.parse(atob(data.content));
      } else {
        leaderboard = {};
        await saveLeaderboard();  // создаём новый файл
      }
    }

    // — Сохранение лидеров в GitHub
    async function saveLeaderboard() {
      const fileData = await getFileData();
      const sha = fileData?.sha;
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      const body = {
        message: `Update leaderboard`,
        content: btoa(JSON.stringify(leaderboard, null, 2)),
        branch: BRANCH,
        ...(sha && { sha })
      };
      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept':        'application/vnd.github.v3+json',
          'Content-Type':  'application/json'
        },
        body: JSON.stringify(body)
      });
      const text = await res.text();
      if (!res.ok) {
        console.error('saveLeaderboard:', res.status, text);
        document.getElementById('feedback').innerText = `Ошибка ${res.status}`;
      }
    }

    // — Показ вопроса
    function generateQuestion() {
      current = hiragana[Math.floor(Math.random()*hiragana.length)];
      document.getElementById('hiragana').innerText = current.char;
      const opts = new Set([current.romaji]);
      while (opts.size<3) opts.add(hiragana[Math.floor(Math.random()*hiragana.length)].romaji);
      const buttons = Array.from(opts).sort(()=>Math.random()-0.5);
      const c = document.getElementById('options'); c.innerHTML = '';
      buttons.forEach(opt=>{
        const b = document.createElement('button');
        b.className='option-button w-full bg-gray-200 py-2 rounded-lg';
        b.innerText=opt;
        b.onclick=()=>checkAnswer(opt,b);
        c.appendChild(b);
      });
      document.getElementById('feedback').innerText='';
      document.getElementById('next-button').classList.add('hidden');
    }

    // — Проверка и лог на GitHub
    async function checkAnswer(sel, btn) {
      const fb = document.getElementById('feedback');
      const next = document.getElementById('next-button');
      const ok = sel===current.romaji;
      if (ok) { score+=10; fb.innerText='Correct!'; fb.className='text-green-600'; }
      else  { score=Math.max(0,score-5); fb.innerText=`Incorrect! It's ${current.romaji}.`; fb.className='text-red-600'; }
      document.getElementById('current-score').innerText=score;

      // Обновляем локально и пушим
      leaderboard[user.id] = {
        name: `${user.first_name}${user.last_name?' '+user.last_name:''}`,
        score: Math.max(leaderboard[user.id]?.score||0, score)
      };
      await saveLeaderboard();

      btn.classList.add(ok?'correct':'incorrect');
      next.classList.remove('hidden');
      document.querySelectorAll('.option-button').forEach(b=>b.disabled=true);
    }

    document.getElementById('next-button').onclick = generateQuestion;

    // — Запуск
    (async()=>{
      await fetchLeaderboard();
      generateQuestion();
      tg.expand();
    })();
  </script>
</body>
</html>
