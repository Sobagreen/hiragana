<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hiragana Practice</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .option-button { transition: transform .2s; }
    .option-button:hover { transform: scale(1.05); }
    .correct { animation: flash-green .5s; }
    .incorrect { animation: flash-red .5s; }
    @keyframes flash-green { from {background:#34d399;} to {background:#fff;} }
    @keyframes flash-red   { from {background:#ef4444;} to {background:#fff;} }
    .timer {
      width: 100%;
      height: 5px;
      background-color: #e5e7eb;
      margin-bottom: 1rem;
    }
    .timer-progress {
      height: 100%;
      background-color: #3b82f6;
      width: 100%;
      transition: width 1s linear;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <!-- Главное меню -->
    <div id="main-menu" class="text-center">
      <h1 class="text-2xl font-bold text-center mb-6">Hiragana Practice</h1>
      <button id="start-game" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 mb-4 text-lg">
        Начать игру
      </button>
    </div>

    <!-- Игровой экран (изначально скрыт) -->
    <div id="game-screen" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <div>
          Правильно: <span id="correct-count" class="font-semibold">0</span>
        </div>
        <div>
          Неправильно: <span id="incorrect-count" class="font-semibold">0</span>
        </div>
      </div>
      <div class="timer">
        <div id="timer-progress" class="timer-progress"></div>
      </div>
      <div id="hiragana" class="text-6xl font-bold text-center mb-6"></div>
      <div id="options" class="space-y-3"></div>
      <div id="feedback" class="text-center mt-4 text-lg"></div>
    </div>

    <!-- Экран результатов (изначально скрыт) -->
    <div id="result-screen" class="hidden text-center">
      <h2 class="text-xl font-bold mb-4">Результаты</h2>
      <div class="mb-6">
        <p>Правильных ответов: <span id="final-correct" class="font-semibold">0</span></p>
        <p>Неправильных ответов: <span id="final-incorrect" class="font-semibold">0</span></p>
      </div>
      <div class="space-y-3">
        <button id="play-again" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
          Играть снова
        </button>
        <button id="exit-game" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
          Выход
        </button>
      </div>
    </div>
  </div>

  <script>
    // — Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user || { id:'test', first_name:'Test', last_name:'' };

    // — Игра
    const hiragana = [
      {char:'あ',romaji:'a'}, {char:'い',romaji:'i'}, {char:'う',romaji:'u'},
      {char:'え',romaji:'e'}, {char:'お',romaji:'o'}, {char:'か',romaji:'ka'},
      {char:'き',romaji:'ki'}, {char:'く',romaji:'ku'}, {char:'け',romaji:'ke'},
      {char:'こ',romaji:'ko'}, {char:'ん',romaji:'n'}
    ];
    
    let current = null;
    let correctAnswers = 0;
    let incorrectAnswers = 0;
    let timer;
    let timeLeft = 30;
    let gameInterval;

    // Элементы интерфейса
    const mainMenu = document.getElementById('main-menu');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const startGameBtn = document.getElementById('start-game');
    const playAgainBtn = document.getElementById('play-again');
    const exitGameBtn = document.getElementById('exit-game');
    const timerProgress = document.getElementById('timer-progress');

    // — Показ вопроса
    function generateQuestion() {
      current = hiragana[Math.floor(Math.random() * hiragana.length)];
      document.getElementById('hiragana').innerText = current.char;
      
      const opts = new Set([current.romaji]);
      while (opts.size < 3) {
        opts.add(hiragana[Math.floor(Math.random() * hiragana.length)].romaji);
      }
      
      const buttons = Array.from(opts).sort(() => Math.random() - 0.5);
      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';
      
      buttons.forEach(opt => {
        const b = document.createElement('button');
        b.className = 'option-button w-full bg-gray-200 py-2 rounded-lg';
        b.innerText = opt;
        b.addEventListener('click', () => checkAnswer(opt, b));
        optionsContainer.appendChild(b);
      });
      
      document.getElementById('feedback').innerText = '';
    }

    // — Проверка ответа
    function checkAnswer(selected, button) {
      const feedback = document.getElementById('feedback');
      const isCorrect = selected === current.romaji;

      if (isCorrect) {
        correctAnswers++;
        feedback.innerText = 'Правильно!';
        feedback.className = 'text-center mt-4 text-lg text-green-600';
      } else {
        incorrectAnswers++;
        feedback.innerText = `Неправильно! Правильный ответ: ${current.romaji}`;
        feedback.className = 'text-center mt-4 text-lg text-red-600';
      }

      // Обновляем счетчики
      document.getElementById('correct-count').innerText = correctAnswers;
      document.getElementById('incorrect-count').innerText = incorrectAnswers;

      // Подсвечиваем кнопку
      button.classList.add(isCorrect ? 'correct' : 'incorrect');
      
      // Блокируем все кнопки на короткое время
      document.querySelectorAll('.option-button').forEach(b => b.disabled = true);
      
      // Через 0.5 секунды генерируем новый вопрос
      setTimeout(generateQuestion, 500);
    }

    // — Запуск игры
    function startGame() {
      // Сброс статистики
      correctAnswers = 0;
      incorrectAnswers = 0;
      timeLeft = 30;
      
      // Обновляем счетчики
      document.getElementById('correct-count').innerText = '0';
      document.getElementById('incorrect-count').innerText = '0';
      
      // Показываем игровой экран
      mainMenu.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      resultScreen.classList.add('hidden');
      
      // Запускаем первый вопрос
      generateQuestion();
      
      // Запускаем таймер
      startTimer();
    }

    // — Таймер игры
    function startTimer() {
      // Сброс таймера
      clearInterval(timer);
      timerProgress.style.width = '100%';
      
      // Обновляем таймер каждую секунду
      timer = setInterval(() => {
        timeLeft--;
        timerProgress.style.width = `${(timeLeft / 30) * 100}%`;
        
        if (timeLeft <= 0) {
          endGame();
        }
      }, 1000);
    }

    // — Завершение игры
    function endGame() {
      clearInterval(timer);
      
      // Показываем результаты
      document.getElementById('final-correct').innerText = correctAnswers;
      document.getElementById('final-incorrect').innerText = incorrectAnswers;
      
      // Переключаем экраны
      gameScreen.classList.add('hidden');
      resultScreen.classList.remove('hidden');
    }

    // — Обработчики кнопок
    startGameBtn.addEventListener('click', startGame);
    playAgainBtn.addEventListener('click', startGame);
    exitGameBtn.addEventListener('click', () => {
      gameScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      mainMenu.classList.remove('hidden');
    });

    // — Инициализация
    tg.expand();
  </script>
</body>
</html>
