<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hiragana Learning Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Arial', sans-serif; }
    .option-button { transition: transform 0.2s, background-color 0.2s; }
    .option-button:hover { transform: scale(1.05); }
    .correct { animation: flash-green 0.5s; }
    .incorrect { animation: flash-red 0.5s; }
    @keyframes flash-green { 0% { background-color: #34d399; } 100% { background-color: #ffffff; } }
    @keyframes flash-red   { 0% { background-color: #ef4444; } 100% { background-color: #ffffff; } }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4 text-gray-800">Hiragana Practice</h1>
    <div id="user-info" class="text-center mb-4 text-gray-600"></div>
    <div id="score" class="text-center mb-4 text-lg font-semibold text-gray-700">
      Score: <span id="current-score">0</span>
    </div>
    <div id="hiragana" class="text-6xl font-bold text-center mb-6 text-gray-900"></div>
    <div id="options" class="space-y-3"></div>
    <div id="feedback" class="text-center mt-4 text-lg"></div>
    <button id="next-button" class="mt-6 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 hidden">
      Next
    </button>
    <div class="mt-8">
      <h2 class="text-xl font-semibold text-gray-800">Leaderboard</h2>
      <ul id="leaderboard" class="mt-2 space-y-2"></ul>
    </div>
  </div>

  <script>
    // → GitHub configuration
    const GITHUB_TOKEN = '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';
    const REPO_OWNER    = 'sobagreen';
    const REPO_NAME     = 'hiragana';
    const FILE_PATH     = 'leaderboard.json';

    // Hiragana data
    const hiragana = [
      { char: 'あ', romaji: 'a' }, { char: 'い', romaji: 'i' }, { char: 'う', romaji: 'u' }, { char: 'え', romaji: 'e' }, { char: 'お', romaji: 'o' },
      { char: 'か', romaji: 'ka' }, { char: 'き', romaji: 'ki' }, { char: 'く', romaji: 'ku' }, { char: 'け', romaji: 'ke' }, { char: 'こ', romaji: 'ko' },
      { char: 'さ', romaji: 'sa' }, { char: 'し', romaji: 'shi' }, { char: 'す', romaji: 'su' }, { char: 'せ', romaji: 'se' }, { char: 'そ', romaji: 'so' },
      { char: 'た', romaji: 'ta' }, { char: 'ち', romaji: 'chi' }, { char: 'つ', romaji: 'tsu' }, { char: 'て', romaji: 'te' }, { char: 'と', romaji: 'to' },
      { char: 'な', romaji: 'na' }, { char: 'に', romaji: 'ni' }, { char: 'ぬ', romaji: 'nu' }, { char: 'ね', romaji: 'ne' }, { char: 'の', romaji: 'no' },
      { char: 'は', romaji: 'ha' }, { char: 'ひ', romaji: 'hi' }, { char: 'ふ', romaji: 'fu' }, { char: 'へ', romaji: 'he' }, { char: 'ほ', romaji: 'ho' },
      { char: 'ま', romaji: 'ma' }, { char: 'み', romaji: 'mi' }, { char: 'む', romaji: 'mu' }, { char: 'め', romaji: 'me' }, { char: 'も', romaji: 'mo' },
      { char: 'や', romaji: 'ya' }, { char: 'ゆ', romaji: 'yu' }, { char: 'よ', romaji: 'yo' },
      { char: 'ら', romaji: 'ra' }, { char: 'り', romaji: 'ri' }, { char: 'る', romaji: 'ru' }, { char: 'れ', romaji: 're' }, { char: 'ろ', romaji: 'ro' },
      { char: 'わ', romaji: 'wa' }, { char: 'を', romaji: 'wo' }, { char: 'ん', romaji: 'n' },
    ];

    // Initialize Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user || { id: 'test_user', first_name: 'Test', last_name: 'User' };
    document.getElementById('user-info').innerText = `Hello, ${user.first_name}!`;

    // Game state
    let score = 0;
    let currentHiragana = null;
    let leaderboard = {};

    // — Получить файл и SHA (если есть)
    async function getFileData() {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      try {
        const res = await fetch(url, {
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        const json = await res.json();
        if (res.status === 404) {
          console.warn('[getFileData] File not found (404)');
          return null;
        }
        if (!res.ok) {
          console.error(`[getFileData] ${res.status}:`, json);
          return null;
        }
        return json;
      } catch (err) {
        console.error('[getFileData] Network or CORS error:', err);
        return null;
      }
    }

    // — Загрузить таблицу лидеров
    async function fetchLeaderboard() {
      const data = await getFileData();
      if (data && data.content) {
        leaderboard = JSON.parse(atob(data.content)) || {};
      } else {
        leaderboard = {};
        await saveLeaderboard();
      }
      updateLeaderboard();
    }

    // — Сохранить таблицу лидеров
    async function saveLeaderboard() {
      const fileData = await getFileData();
      const sha = fileData?.sha;
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      const payload = {
        message: `Update leaderboard for user ${user.id}`,
        content: btoa(JSON.stringify(leaderboard, null, 2)),
        ...(sha && { sha })
      };
      try {
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!res.ok) {
          console.error(`[saveLeaderboard] ${res.status}:`, json);
          document.getElementById('feedback').innerText =
            `Ошибка ${res.status}: ${json.message || 'см. консоль'}`;
          return;
        }
        console.log('[saveLeaderboard] Success:', json.content.html_url);
        updateLeaderboard();
      } catch (err) {
        console.error('[saveLeaderboard] Network or CORS error:', err);
        document.getElementById('feedback').innerText = 'Сетевая ошибка, проверьте консоль.';
      }
    }

    // Обновить отображение таблицы лидеров
    function updateLeaderboard() {
      const ul = document.getElementById('leaderboard');
      ul.innerHTML = '';
      Object.entries(leaderboard)
        .sort(([, a], [, b]) => b.score - a.score)
        .slice(0, 5)
        .forEach(([id, entry]) => {
          const li = document.createElement('li');
          li.className = 'bg-gray-50 p-2 rounded flex justify-between';
          li.innerHTML = `<span>${entry.name}</span><span>${entry.score}</span>`;
          ul.appendChild(li);
        });
    }

    // Инициализация текущего игрока
    async function initLeaderboard() {
      await fetchLeaderboard();
      const fullName = `${user.first_name}${user.last_name ? ' ' + user.last_name : ''}`;
      if (!leaderboard[user.id]) {
        leaderboard[user.id] = { name: fullName, score: 0 };
        await saveLeaderboard();
      }
    }

    // Генерация вопроса
    function generateQuestion() {
      currentHiragana = hiragana[Math.floor(Math.random() * hiragana.length)];
      document.getElementById('hiragana').innerText = currentHiragana.char;

      const opts = new Set([currentHiragana.romaji]);
      while (opts.size < 3) {
        opts.add(hiragana[Math.floor(Math.random() * hiragana.length)].romaji);
      }
      const options = Array.from(opts).sort(() => Math.random() - 0.5);

      const container = document.getElementById('options');
      container.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-button w-full bg-gray-200 py-2 rounded-lg text-lg hover:bg-gray-300';
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt, btn);
        container.appendChild(btn);
      });

      document.getElementById('feedback').innerText = '';
      document.getElementById('next-button').classList.add('hidden');
    }

    // Проверка ответа
    async function checkAnswer(selected, button) {
      const fb = document.getElementById('feedback');
      const nextBtn = document.getElementById('next-button');
      if (selected === currentHiragana.romaji) {
        score += 10;
        fb.innerText = 'Correct!';
        fb.className = 'text-center mt-4 text-lg text-green-600';
        button.classList.add('correct');
        leaderboard[user.id].score = Math.max(leaderboard[user.id].score, score);
        await saveLeaderboard();
      } else {
        score = Math.max(0, score - 5);
        fb.innerText = `Incorrect! It's ${currentHiragana.romaji}.`;
        fb.className = 'text-center mt-4 text-lg text-red-600';
        button.classList.add('incorrect');
      }
      document.getElementById('current-score').innerText = score;
      nextBtn.classList.remove('hidden');
      document.querySelectorAll('.option-button').forEach(b => b.disabled = true);
    }

    // «Next»
    document.getElementById('next-button').onclick = generateQuestion;

    // Старт
    initLeaderboard().then(generateQuestion);
    tg.expand();
  </script>
</body>
</html>
