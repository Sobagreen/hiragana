<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hiragana Learning Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Arial', sans-serif; }
    .option-button { transition: transform 0.2s, background-color 0.2s; }
    .option-button:hover { transform: scale(1.05); }
    .correct { animation: flash-green 0.5s; }
    .incorrect { animation: flash-red 0.5s; }
    @keyframes flash-green { 0% { background-color: #34d399; } 100% { background-color: #ffffff; } }
    @keyframes flash-red   { 0% { background-color: #ef4444; } 100% { background-color: #ffffff; } }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4 text-gray-800">Hiragana Practice</h1>
    <div id="user-info" class="text-center mb-4 text-gray-600"></div>
    <div class="text-center mb-4 text-lg font-semibold text-gray-700">
      Score: <span id="current-score">0</span>
    </div>
    <div id="hiragana" class="text-6xl font-bold text-center mb-6 text-gray-900"></div>
    <div id="options" class="space-y-3"></div>
    <div id="feedback" class="text-center mt-4 text-lg"></div>
    <button id="next-button" class="mt-6 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 hidden">
      Next
    </button>
  </div>

  <script>
    // — Настройки GitHub
    const GITHUB_TOKEN = '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';
    const REPO_OWNER    = 'sobagreen';
    const REPO_NAME     = 'hiragana';
    const FILE_PATH     = 'leaderboard.json';

    // — Данные для вопросов
    const hiragana = [
      { char: 'あ', romaji: 'a' }, { char: 'い', romaji: 'i' }, { char: 'う', romaji: 'u' },
      { char: 'え', romaji: 'e' }, { char: 'お', romaji: 'o' }, { char: 'か', romaji: 'ka' },
      { char: 'き', romaji: 'ki' }, { char: 'く', romaji: 'ku' }, { char: 'け', romaji: 'ke' },
      { char: 'こ', romaji: 'ko' }, { char: 'さ', romaji: 'sa' }, { char: 'し', romaji: 'shi' },
      { char: 'す', romaji: 'su' }, { char: 'せ', romaji: 'se' }, { char: 'そ', romaji: 'so' },
      { char: 'た', romaji: 'ta' }, { char: 'ち', romaji: 'chi' }, { char: 'つ', romaji: 'tsu' },
      { char: 'て', romaji: 'te' }, { char: 'と', romaji: 'to' }, { char: 'な', romaji: 'na' },
      { char: 'に', romaji: 'ni' }, { char: 'ぬ', romaji: 'nu' }, { char: 'ね', romaji: 'ne' },
      { char: 'の', romaji: 'no' }, { char: 'は', romaji: 'ha' }, { char: 'ひ', romaji: 'hi' },
      { char: 'ふ', romaji: 'fu' }, { char: 'へ', romaji: 'he' }, { char: 'ほ', romaji: 'ho' },
      { char: 'ま', romaji: 'ma' }, { char: 'み', romaji: 'mi' }, { char: 'む', romaji: 'mu' },
      { char: 'め', romaji: 'me' }, { char: 'も', romaji: 'mo' }, { char: 'や', romaji: 'ya' },
      { char: 'ゆ', romaji: 'yu' }, { char: 'よ', romaji: 'yo' }, { char: 'ら', romaji: 'ra' },
      { char: 'り', romaji: 'ri' }, { char: 'る', romaji: 'ru' }, { char: 'れ', romaji: 're' },
      { char: 'ろ', romaji: 'ro' }, { char: 'わ', romaji: 'wa' }, { char: 'を', romaji: 'wo' },
      { char: 'ん', romaji: 'n' }
    ];

    // — Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user || { id: 'test_user', first_name: 'Test', last_name: 'User' };
    document.getElementById('user-info').innerText = `Hello, ${user.first_name}!`;

    // — Состояние игры
    let score = 0;
    let current = null;

    // — Получение файла и SHA
    async function getFileData() {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      try {
        const res = await fetch(url, {
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        const json = await res.json();
        if (res.status === 404) {
          console.warn('[getFileData] 404: файл не найден');
          return null;
        }
        if (!res.ok) {
          console.error(`[getFileData] ${res.status}:`, json);
          return null;
        }
        return json;
      } catch (e) {
        console.error('[getFileData] network/CORS error:', e);
        return null;
      }
    }

    // — Загрузка лидеров
    async function fetchLeaderboard() {
      const data = await getFileData();
      if (data && data.content) {
        window.leaderboard = JSON.parse(atob(data.content)) || {};
      } else {
        window.leaderboard = {};
        await saveLeaderboard();
      }
      renderLeaderboard();
    }

    // — Сохранение лидеров
    async function saveLeaderboard() {
      const fileData = await getFileData();
      const sha = fileData?.sha;
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      const body = {
        message: `Update leaderboard for ${user.id}`,
        content: btoa(JSON.stringify(window.leaderboard, null, 2)),
        ...(sha && { sha })
      };
      try {
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        if (!res.ok) {
          console.error(`[saveLeaderboard] ${res.status}:`, json);
          document.getElementById('feedback').innerText = `Ошибка ${res.status}: ${json.message}`;
          return;
        }
        console.log('[saveLeaderboard] OK →', json.content.html_url);
        renderLeaderboard();
      } catch (e) {
        console.error('[saveLeaderboard] network/CORS error:', e);
        document.getElementById('feedback').innerText = 'Сетевая ошибка, смотрите консоль.';
      }
    }

    // — Отрисовка лидеров
    function renderLeaderboard() {
      const ul = document.getElementById('options').closest('div').nextElementSibling.querySelector('#leaderboard');
      // Если вам нужен Leaderboard в этом варианте, добавьте <ul id="leaderboard"></ul> в HTML.
      // Здесь же рендер-лидерборда по window.leaderboard
    }

    // — Генерация нового вопроса
    function generateQuestion() {
      current = hiragana[Math.floor(Math.random() * hiragana.length)];
      document.getElementById('hiragana').innerText = current.char;
      const opts = new Set([current.romaji]);
      while (opts.size < 3) {
        opts.add(hiragana[Math.floor(Math.random() * hiragana.length)].romaji);
      }
      const buttons = Array.from(opts).sort(() => Math.random() - .5);
      const container = document.getElementById('options');
      container.innerHTML = '';
      buttons.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-button w-full bg-gray-200 py-2 rounded-lg hover:bg-gray-300';
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt, btn);
        container.appendChild(btn);
      });
      document.getElementById('feedback').innerText = '';
      document.getElementById('next-button').classList.add('hidden');
    }

    // — Проверка ответа
    async function checkAnswer(selected, btn) {
      const fb = document.getElementById('feedback');
      const nextBtn = document.getElementById('next-button');
      const correct = selected === current.romaji;
      if (correct) {
        score += 10;
        fb.innerText = 'Correct!';
        fb.className = 'text-green-600';
      } else {
        score = Math.max(0, score - 5);
        fb.innerText = `Incorrect! It's ${current.romaji}.`;
        fb.className = 'text-red-600';
      }
      document.getElementById('current-score').innerText = score;

      // Обновляем локальный leaderboard и сохраняем
      window.leaderboard = window.leaderboard || {};
      window.leaderboard[user.id] = {
        name: `${user.first_name}${user.last_name ? ' '+user.last_name : ''}`,
        score: Math.max(window.leaderboard[user.id]?.score || 0, score)
      };
      await saveLeaderboard();

      btn.classList.add(correct ? 'correct' : 'incorrect');
      nextBtn.classList.remove('hidden');
      document.querySelectorAll('.option-button').forEach(b => b.disabled = true);
    }

    // — Обработчик «Next»
    document.getElementById('next-button').onclick = generateQuestion;

    // — Стартовый блок
    (async () => {
      await fetchLeaderboard();
      // Инициализация текущего игрока, если нужно
      window.leaderboard[user.id] = window.leaderboard[user.id] || {
        name: `${user.first_name}${user.last_name? ' '+user.last_name: ''}`, score: 0
      };
      await saveLeaderboard();
      generateQuestion();
      tg.expand();
    })();
  </script>
</body>
</html>
